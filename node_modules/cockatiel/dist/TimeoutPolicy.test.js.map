{"version":3,"file":"TimeoutPolicy.test.js","sourceRoot":"","sources":["../src/TimeoutPolicy.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { expect } from 'chai';\nimport { SinonStub, stub } from 'sinon';\nimport { promisify } from 'util';\nimport { runInChild } from './common/util.test';\nimport { TaskCancelledError } from './errors/TaskCancelledError';\nimport { timeout } from './Policy';\nimport { TimeoutPolicy, TimeoutStrategy } from './TimeoutPolicy';\n\nconst delay = promisify(setTimeout);\n\ndescribe('TimeoutPolicy', () => {\n  it('works when no timeout happens', async () => {\n    const policy = timeout(1000, TimeoutStrategy.Cooperative);\n    expect(await policy.execute(() => 42)).to.equal(42);\n  });\n\n  it('properly cooperatively cancels', async () => {\n    const policy = timeout(2, TimeoutStrategy.Cooperative);\n    expect(\n      await policy.execute(async ({ signal }) => {\n        expect(signal.aborted).to.be.false;\n        await delay(3);\n        expect(signal.aborted).to.be.true;\n        return 42;\n      }),\n    ).to.equal(42);\n  });\n\n  it('properly aggressively cancels', async () => {\n    const policy = timeout(5, TimeoutStrategy.Aggressive);\n    let verified: Promise<void>;\n    await expect(\n      policy.execute(\n        async ({ signal }) =>\n          (verified = (async () => {\n            await delay(0);\n            expect(signal.aborted).to.be.false;\n            await delay(5);\n            expect(signal.aborted).to.be.true;\n          })()),\n      ),\n    ).to.eventually.be.rejectedWith(TaskCancelledError);\n\n    await verified!;\n  });\n\n  it('does not unref by default', async () => {\n    // this would timeout if the timers were referenced\n    const output = await runInChild(`\n      c.timeout(100, 'aggressive')\n        .execute(() => new Promise(() => {}));\n    `);\n\n    expect(output).to.contain('Operation timed out');\n  });\n\n  it('unrefs as requested', async () => {\n    // this would timeout if the timers were referenced\n    const output = await runInChild(`\n      c.timeout(60 * 1000, 'aggressive')\n        .dangerouslyUnref()\n        .execute(() => new Promise(() => {}));\n    `);\n\n    expect(output).to.be.empty;\n  });\n\n  it('links parent cancellation token', async () => {\n    const parent = new AbortController();\n    await timeout(1000, TimeoutStrategy.Cooperative).execute((_, signal) => {\n      expect(signal.aborted).to.be.false;\n      parent.abort();\n      expect(signal.aborted).to.be.true;\n    }, parent.signal);\n  });\n\n  it('still has own timeout if given parent', async () => {\n    const parent = new AbortController();\n    await timeout(1, TimeoutStrategy.Cooperative).execute(async (_, signal) => {\n      expect(signal.aborted).to.be.false;\n      await delay(3);\n      expect(signal.aborted).to.be.true;\n    }, parent.signal);\n  });\n\n  describe('events', () => {\n    let onSuccess: SinonStub;\n    let onFailure: SinonStub;\n    let onTimeout: SinonStub;\n    let agg: TimeoutPolicy;\n    let coop: TimeoutPolicy;\n\n    beforeEach(() => {\n      onSuccess = stub();\n      onFailure = stub();\n      onTimeout = stub();\n      coop = timeout(2, TimeoutStrategy.Cooperative);\n      agg = timeout(2, TimeoutStrategy.Aggressive);\n      for (const p of [coop, agg]) {\n        p.onFailure(onFailure);\n        p.onSuccess(onSuccess);\n        p.onTimeout(onTimeout);\n      }\n    });\n\n    it('emits a success event (cooperative)', async () => {\n      await coop.execute(() => 42);\n      await delay(3);\n      expect(onSuccess).to.have.been.called;\n      expect(onFailure).to.not.have.been.called;\n      expect(onTimeout).to.not.have.been.called;\n    });\n\n    it('emits a success event (aggressive)', async () => {\n      await agg.execute(() => 42);\n      await delay(3);\n      expect(onSuccess).to.have.been.called;\n      expect(onFailure).to.not.have.been.called;\n      expect(onTimeout).to.not.have.been.called;\n    });\n\n    it('emits a timeout event (cooperative)', async () => {\n      coop.onTimeout(onTimeout);\n      await coop.execute(() => delay(3));\n      expect(onSuccess).to.have.been.called; // still returned a good value\n      expect(onTimeout).to.have.been.called;\n      expect(onFailure).to.not.have.been.called;\n    });\n\n    it('emits a timeout event (aggressive)', async () => {\n      await expect(agg.execute(() => delay(3))).to.be.rejectedWith(TaskCancelledError);\n      expect(onSuccess).to.not.have.been.called;\n      expect(onTimeout).to.have.been.called;\n      expect(onFailure).to.have.been.called;\n    });\n\n    it('emits a failure event (cooperative)', async () => {\n      await expect(\n        coop.execute(() => {\n          throw new Error('oh no!');\n        }),\n      ).to.be.rejected;\n      await delay(3);\n\n      expect(onSuccess).to.not.have.been.called;\n      expect(onTimeout).to.not.have.been.called;\n      expect(onFailure).to.have.been.called;\n    });\n\n    it('emits a failure event (aggressive)', async () => {\n      await expect(\n        agg.execute(() => {\n          throw new Error('oh no!');\n        }),\n      ).to.be.rejected;\n      await delay(3);\n\n      expect(onSuccess).to.not.have.been.called;\n      expect(onTimeout).to.not.have.been.called;\n      expect(onFailure).to.have.been.called;\n    });\n  });\n});\n"]}